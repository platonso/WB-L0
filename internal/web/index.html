<!DOCTYPE html>
<html lang="ru" xmlns:margin-bottom="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Viewer</title>
  <style>
    :root {
      --primary: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --danger: #ef4444;
      --background: #f8fafc;
      --card: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: var(--background);
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--card);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 2rem;
      color: var(--primary);
    }

    .search-box {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    input {
      flex: 1;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
    }

    button {
      padding: 12px 24px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    button:hover {
      background: #1d4ed8;
    }

    button:disabled {
      background: var(--secondary);
      cursor: not-allowed;
    }

    #loading {
      text-align: center;
      color: var(--secondary);
    }

    #result {
      margin-top: 2rem;
      display: none;
    }

    .order-card {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .section-title {
      color: var(--primary);
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 0.5rem;
      margin-top: 1.5rem;
    }

    .json-view {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 14px;
    }

    .stats {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      color: var(--secondary);
      font-size: 14px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ JSON */
    .json-view .key { color: #ff79c6; }
    .json-view .string { color: #50fa7b; }
    .json-view .number { color: #bd93f9; }
    .json-view .boolean { color: #ff79c6; }
    .json-view .null { color: #ff5555; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üì¶ –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–∫–∞–∑–æ–≤</h1>
    <p>–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</p>
  </div>

  <div class="search-box">
    <input type="text" id="orderId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞" onkeypress="handleKeyPress(event)">
    <button onclick="getOrder()" id="searchBtn">–ù–∞–π—Ç–∏</button>
  </div>

  <div id="loading" style="display: none;">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞...</p>
  </div>

  <div id="error" style="display: none; color: var(--danger);"></div>

  <div id="result">
    <h2 class="section-title">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞</h2>
    <div class="stats" style="margin-bottom: 20px;">
      <span id="responseTime"></span>
      <span id="cacheStatus"></span>
    </div>
    <div class="json-view" id="orderData"></div>
  </div>
</div>

<script>

  function handleKeyPress(event) {
    if (event.key === 'Enter') {
      getOrder();
    }
  }

  async function getOrder() {
    const orderId = document.getElementById('orderId').value.trim();
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const searchBtn = document.getElementById('searchBtn');

    errorDiv.style.display = 'none';
    resultDiv.style.display = 'none';
    errorDiv.textContent = '';

    if (!orderId) {
      showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞');
      return;
    }

    if (orderId.length > 50) {
      showError('ID –∑–∞–∫–∞–∑–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤)');
      return;
    }

    loadingDiv.style.display = 'block';
    searchBtn.disabled = true;

    try {
      const startTime = performance.now();
      const response = await fetch(`/order/${encodeURIComponent(orderId)}`);
      const endTime = performance.now();
      const responseTime = Math.round(endTime - startTime);

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(getErrorMessage(response.status, errorText));
      }

      // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const dataSource = response.headers.get('X-Data-Source');
      const order = await response.json();

      displayOrder(order, responseTime, dataSource);

    } catch (error) {
      showError(error.message);
    } finally {
      loadingDiv.style.display = 'none';
      searchBtn.disabled = false;
    }
  }

  function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
  }

  function displayOrder(order, responseTime, dataSource) {
    const resultDiv = document.getElementById('result');
    const orderDataDiv = document.getElementById('orderData');
    const responseTimeSpan = document.getElementById('responseTime');
    const cacheStatusSpan = document.getElementById('cacheStatus');

    // –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
    responseTimeSpan.textContent = `–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${responseTime}–º—Å`;

    // –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
    if (dataSource === 'cache') {
      cacheStatusSpan.textContent = '‚úì –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–µ—à–∞';
      cacheStatusSpan.style.color = '#10b981';
    } else {
      cacheStatusSpan.textContent = '‚úì –î–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö';
      cacheStatusSpan.style.color = '#3b82f6';
    }

    function getValue(obj, key) {
      return (obj && obj[key] !== undefined && obj[key] !== null) ? obj[key] : '';
    }

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞
    let html = `<h3>Order</h3><table border="1" cellpadding="5" cellspacing="0">`;

    const topFields = ["order_uid", "track_number", "entry", "locale", "internal_signature", "customer_id", "delivery_service", "shardkey", "sm_id", "date_created", "oof_shard"];
    topFields.forEach(field => {
      html += `<tr><th>${field}</th><td>${getValue(order, field)}</td></tr>`;
    });
    html += `</table>`;

    // Delivery
    html += `<h3>Delivery</h3><table border="1" cellpadding="5" cellspacing="0">`;
    const deliveryFields = ["name","phone","zip","city","address","region","email"];
    deliveryFields.forEach(field => {
      html += `<tr><th>${field}</th><td>${getValue(order.delivery, field)}</td></tr>`;
    });
    html += `</table>`;

    // Payment
    html += `<h3>Payment</h3><table border="1" cellpadding="5" cellspacing="0">`;
    const paymentFields = ["transaction","request_id","currency","provider","amount","payment_dt","bank","delivery_cost","goods_total","custom_fee"];
    paymentFields.forEach(field => {
      let value = getValue(order.payment, field);
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º timestamp –≤ –¥–∞—Ç—É
      if (field === "payment_dt" && value) {
        value = new Date(value * 1000).toLocaleString();
      }
      html += `<tr><th>${field}</th><td>${value}</td></tr>`;
    });
    html += `</table>`;

    // Items
    html += `<h3>Items</h3><table border="1" cellpadding="5" cellspacing="0"><tr>`;
    const itemFields = ["chrt_id","track_number","price","rid","name","sale","size","total_price","nm_id","brand","status"];
    itemFields.forEach(field => { html += `<th>${field}</th>` });
    html += `</tr>`;

    order.items.forEach(item => {
      html += `<tr>`;
      itemFields.forEach(field => {
        html += `<td>${getValue(item, field)}</td>`;
      });
      html += `</tr>`;
    });
    html += `</table>`;

    orderDataDiv.innerHTML = html;
    resultDiv.style.display = 'block';
  }

  function getErrorMessage(status, errorText) {
    switch (status) {
      case 400:
        return '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID –∑–∞–∫–∞–∑–∞';
      case 404:
        return '–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω';
      case 500:
        return '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
      default:
        return errorText || `–û—à–∏–±–∫–∞: ${status}`;
    }
  }

  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤
  function setupAutocomplete() {
    const orderIdInput = document.getElementById('orderId');

    orderIdInput.addEventListener('focus', function() {
      if (!this.value) {
        this.placeholder = '–ù–∞–ø—Ä–∏–º–µ—Ä: b563feb7b2b84b6test';
      }
    });

    orderIdInput.addEventListener('blur', function() {
      this.placeholder = '–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–∫–∞–∑–∞';
    });
  }

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', function() {
    setupAutocomplete();

    const urlParams = new URLSearchParams(window.location.search);
    const demoId = urlParams.get('demo');
    if (demoId) {
      document.getElementById('orderId').value = demoId;
    }
  });
</script>
</body>
</html>